<!DOCTYPE html>
<!--
  ‚ö†Ô∏è LEGAL NOTICE ‚ö†Ô∏è
  This source code is VIEWABLE for educational purposes only.
  MODIFICATION IS STRICTLY PROHIBITED without explicit written permission.
  Unauthorized modification may violate the Economic Espionage Act and other laws.
  Violators may face criminal prosecution and civil penalties.
  
  Developer: Asterisk
  Owner & Idea: Kaitlyn Foreman
  See LICENSE file for full terms.
-->
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
<title>Failure Is Fatal : Life Or Death - Phlebotomy</title>

<!-- SEO Meta Tags -->
<meta name="description" content="Intense scenario-based training simulator for nursing students. Experience real medical emergencies where every decision matters. High-stakes scenarios with timers and realistic patient outcomes." />
<meta name="keywords" content="nursing training, medical scenarios, nursing education, NCLEX prep, medical simulation, nursing students" />
<meta name="author" content="Asterisk" />
<meta name="owner" content="Kaitlyn Foreman" />
<meta name="robots" content="index, follow" />

<!-- Open Graph / Facebook / Discord -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https://gamedev44.github.io/FIF-LOD/pages/flashtest.html" />
<meta property="og:title" content="Failure Is Fatal : Life Or Death" />
<meta property="og:description" content="Intense scenario-based training simulator for nursing students. Experience real medical emergencies where every decision matters." />
<meta property="og:image" content="https://gamedev44.github.io/FIF-LOD/assets/og-image.png" />
<meta property="og:site_name" content="Failure Is Fatal : Life Or Death" />

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content="https://gamedev44.github.io/FIF-LOD/pages/flashtest.html" />
<meta name="twitter:title" content="Failure Is Fatal : Life Or Death" />
<meta name="twitter:description" content="Intense scenario-based training simulator for nursing students. Experience real medical emergencies where every decision matters." />
<meta name="twitter:image" content="https://gamedev44.github.io/FIF-LOD/assets/twitter-image.png" />
<meta name="twitter:creator" content="@gamedev44" />

<!-- Discord uses Open Graph tags above -->
<!-- Custom Medicine Pill Cursor -->
<style type="text/css">
body, * {
  cursor: url('http://www.rw-designer.com/cursor-extern.php?id=190554'), auto;
}
button, a, .choice, .hint-button, .modal-button, .loading-continue-btn, .tip-close {
  cursor: url('http://www.rw-designer.com/cursor-extern.php?id=190554'), pointer;
}
</style>
<style>
:root {
  --card-w: min(92vw, 420px);
  --card-h: min(80vh, 640px);
  --radius: 18px;
  --dur: 0.7s;
  --bg: #0b0e14;
  --front: #111827;
  --back: #020617;
  --accent: #38bdf8;
  --good: #22c55e;
  --bad: #ef4444;
  
  /* Responsive sizing */
  --base-font-size: clamp(14px, 2.5vw, 16px);
  --heading-size: clamp(1.5rem, 4vw, 2.5rem);
  --button-padding: clamp(12px, 2vw, 20px);
  --container-padding: clamp(16px, 4vw, 40px);
}

* { box-sizing: border-box; }

body {
  margin: 0;
  min-height: 100vh;
  display: grid;
  place-items: center;
  background: radial-gradient(1200px 600px at 50% 0%, #111827, var(--bg));
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
  color: #e5e7eb;
}

.scene {
  width: 100vw;
  height: 100vh;
  display: grid;
  place-items: center;
  perspective: 1600px;
  touch-action: manipulation;
  position: relative;
}

.controls {
  position: absolute;
  top: 20px;
  left: 20px;
  right: 20px;
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  z-index: 10;
}

.back-home {
  padding: 8px 16px;
  border-radius: 12px;
  border: none;
  background: rgba(56,189,248,.15);
  color: var(--accent);
  cursor: pointer;
  text-decoration: none;
  font-size: 0.9rem;
  border: 1px solid rgba(56,189,248,.3);
}

.category-select {
  padding: 8px 16px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.2);
  background: rgba(0,0,0,.3);
  color: #e5e7eb;
  cursor: pointer;
  font-size: 0.9rem;
}

.user-profile-btn {
  padding: 8px 16px;
  border-radius: 12px;
  border: 1px solid rgba(56,189,248,.3);
  background: rgba(56,189,248,.15);
  color: var(--accent);
  cursor: pointer;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
}

.user-profile-btn:hover {
  background: rgba(56,189,248,.25);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
}

.progress-display {
  display: flex;
  gap: 12px;
  align-items: center;
  font-size: 0.9rem;
}

.progress-display span {
  padding: 6px 12px;
  border-radius: 8px;
  background: rgba(0,0,0,.3);
  border: 1px solid rgba(255,255,255,.1);
}

.drop-zone {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: none;
  place-items: center;
  background: rgba(0,0,0,.8);
  z-index: 100;
  border: 3px dashed var(--accent);
}

.drop-zone.active {
  display: grid;
}

.drop-zone-text {
  text-align: center;
  font-size: 1.5rem;
  color: var(--accent);
}

.card {
  width: var(--card-w);
  height: var(--card-h);
  position: relative;
  transform-style: preserve-3d;
  transition: transform var(--dur) cubic-bezier(.22,1,.36,1);
  cursor: pointer;
  user-select: none;
}

.card.is-flipped { transform: rotateY(180deg); }

.face {
  position: absolute;
  inset: 0;
  padding: 24px;
  border-radius: var(--radius);
  backface-visibility: hidden;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  /* Glassmorphism styling */
  background: rgba(17, 24, 39, 0.7);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.1),
    0 20px 60px rgba(0, 0, 0, 0.45);
}

.front {
  background: linear-gradient(135deg, rgba(2, 6, 23, 0.8), rgba(17, 24, 39, 0.7));
}

.back {
  background: linear-gradient(135deg, rgba(2, 6, 23, 0.8), rgba(2, 6, 23, 0.7));
  transform: rotateY(180deg);
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.back-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: rgba(56,189,248,.15);
  color: var(--accent);
  font-size: 18px;
  cursor: pointer;
}

.qnum { font-size: .8rem; opacity: .7; }

.content {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 14px;
  overflow-y: auto;
  overflow-x: hidden;
  /* Hide scrollbar by default, show custom if needed */
  scrollbar-width: thin; /* Firefox - thin scrollbar */
  scrollbar-color: var(--accent) rgba(0,0,0,.3); /* Firefox - thumb and track colors */
  -ms-overflow-style: none; /* IE and Edge - hide */
}

/* Custom scrollbar for WebKit browsers (Chrome, Safari, Edge) */
.content::-webkit-scrollbar {
  width: 8px;
}

.content::-webkit-scrollbar-track {
  background: rgba(0,0,0,.2);
  border-radius: 10px;
  margin: 4px;
}

.content::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, var(--accent), #60a5fa);
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,.2);
}

.content::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #60a5fa, var(--accent));
}

/* Hide scrollbar on mobile/touch devices */
@media (hover: none) and (pointer: coarse) {
  .content {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .content::-webkit-scrollbar {
    display: none;
  }
}

.card-image {
  max-width: 100%;
  max-height: 200px;
  border-radius: 8px;
  object-fit: contain;
  margin: 10px 0;
}

.choices {
  display: grid;
  gap: 10px;
  width: 100%;
}

.choice {
  padding: 10px 14px;
  border-radius: 12px;
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.08);
  cursor: pointer;
  transition: all 0.2s;
}

.choice:hover {
  background: rgba(255,255,255,.08);
}

.choice.selected { outline: 2px solid var(--accent); }
.choice.correct { background: rgba(34,197,94,.2); }
.choice.wrong { background: rgba(239,68,68,.2); }

.hint { font-size: .7rem; opacity: .6; align-self: flex-end; }

.loading {
  text-align: center;
  padding: 40px;
}

.error {
  text-align: center;
  padding: 40px;
  color: var(--bad);
}

.scenario {
  background: rgba(239,68,68,.15);
  border-left: 4px solid var(--bad);
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  animation: pulse 1s ease-in-out infinite;
}

.scenario-text {
  font-weight: 600;
  color: #fca5a5;
  margin-bottom: 8px;
}

.timer {
  background: rgba(239,68,68,.2);
  border: 2px solid var(--bad);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--bad);
  animation: pulse 1s ease-in-out infinite;
}

.timer.warning {
  animation: pulse 0.5s ease-in-out infinite;
  background: rgba(239,68,68,.4);
}

.failure-message {
  background: rgba(239,68,68,.2);
  border: 2px solid var(--bad);
  padding: 16px;
  border-radius: 8px;
  margin-top: 16px;
  color: var(--bad);
  font-weight: 600;
  text-align: center;
}

.death-certificate {
  background: rgba(0,0,0,.5);
  border: 3px solid var(--bad);
  padding: 20px;
  border-radius: 8px;
  margin-top: 16px;
  color: var(--bad);
  font-family: 'Courier New', monospace;
}

.death-header {
  font-size: 1.5rem;
  font-weight: bold;
  text-align: center;
  margin-bottom: 16px;
  border-bottom: 2px solid var(--bad);
  padding-bottom: 8px;
}

.death-info {
  line-height: 2;
  font-size: 0.9rem;
}

.death-info div {
  margin: 8px 0;
}

.success-message {
  background: rgba(34,197,94,.2);
  border: 2px solid var(--good);
  padding: 16px;
  border-radius: 8px;
  margin-top: 16px;
  color: var(--good);
  font-weight: 600;
  text-align: center;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.8);
  display: none;
  place-items: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease;
}

.modal-overlay.show {
  display: grid;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal {
  background: linear-gradient(135deg, #020617, var(--front));
  border-radius: var(--radius);
  padding: 40px;
  max-width: 500px;
  width: 90%;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,.6);
  border: 2px solid var(--good);
  animation: slideUp 0.4s ease;
}

.modal-icon {
  font-size: 4rem;
  margin-bottom: 20px;
  animation: pulse 1s ease-in-out infinite;
}

.modal-title {
  font-size: 2rem;
  color: var(--good);
  margin-bottom: 16px;
  font-weight: bold;
}

.modal-message {
  font-size: 1.2rem;
  color: #e5e7eb;
  line-height: 1.6;
  margin-bottom: 24px;
}

.modal-button {
  padding: 12px 32px;
  border-radius: 12px;
  border: none;
  background: var(--good);
  color: white;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.modal-button:hover {
  background: #16a34a;
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(34,197,94,.3);
}

.failure-modal {
  border-color: var(--bad);
}

.failure-button {
  background: var(--bad);
}

.failure-button:hover {
  background: #dc2626;
  box-shadow: 0 10px 20px rgba(239,68,68,.3);
}

/* Responsive Design - Mobile First */
@media screen and (max-width: 768px) {
  :root {
    --card-w: min(95vw, 380px);
    --card-h: min(75vh, 600px);
    --radius: 14px;
  }
  
  .controls {
    top: 10px;
    left: 10px;
    right: 10px;
    gap: 8px;
  }
  
  .back-home, .category-select {
    font-size: 0.8rem;
    padding: 6px 12px;
  }
  
  .card {
    width: var(--card-w);
    height: var(--card-h);
  }
  
  .face {
    padding: 16px;
  }
  
  .content h2 {
    font-size: clamp(1.2rem, 5vw, 1.8rem);
  }
  
  .choice {
    padding: 12px;
    font-size: 0.9rem;
  }
  
  .timer {
    width: 50px;
    height: 50px;
    font-size: 1.2rem;
    top: 10px;
    right: 10px;
  }
  
  .modal {
    padding: 24px;
    max-width: 90vw;
  }
  
  .modal-icon {
    font-size: 3rem;
  }
  
  .modal-title {
    font-size: 1.5rem;
  }
  
  .modal-message {
    font-size: 1rem;
  }
  
  .scenario {
    padding: 12px;
    font-size: 0.9rem;
  }
  
  .death-certificate {
    padding: 16px;
    font-size: 0.85rem;
  }
}

@media screen and (min-width: 769px) and (max-width: 1024px) {
  :root {
    --card-w: min(85vw, 400px);
    --card-h: min(78vh, 620px);
  }
}

@media screen and (min-width: 1025px) {
  :root {
    --card-w: min(92vw, 420px);
    --card-h: min(80vh, 640px);
  }
  
  .controls {
    max-width: 1200px;
    margin: 0 auto;
  }
}

/* Landscape mobile optimization */
@media screen and (max-height: 500px) and (orientation: landscape) {
  :root {
    --card-h: min(90vh, 500px);
  }
  
  .face {
    padding: 12px;
  }
  
  .content h2 {
    font-size: 1.2rem;
    margin: 8px 0;
  }
  
  .scenario {
    padding: 8px;
    margin-bottom: 10px;
    font-size: 0.85rem;
  }
}

/* High DPI displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .card {
    transform-style: preserve-3d;
  }
}

/* Touch device optimizations */
@media (hover: none) and (pointer: coarse) {
  .choice, .back-btn, .back-home, .modal-button {
    min-height: 44px;
    min-width: 44px;
  }
  
  .card {
    cursor: default;
  }
}

/* Loading Screen */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease;
}

.loading-overlay.active {
  display: flex;
}

.loading-screen {
  background: rgba(17, 24, 39, 0.8);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius);
  padding: 40px;
  text-align: center;
  max-width: 500px;
  width: 90%;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.loading-icon {
  font-size: 3rem;
  margin-bottom: 20px;
  animation: pulse 1.5s ease-in-out infinite;
}

.loading-tip {
  font-size: 1.1rem;
  color: var(--accent);
  margin-bottom: 20px;
  line-height: 1.6;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.5s ease;
}

.loading-progress {
  font-size: 0.9rem;
  opacity: 0.7;
  margin-bottom: 20px;
}

.loading-continue-btn {
  padding: 12px 24px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, var(--accent), #60a5fa);
  color: white;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
}

.loading-continue-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(56, 189, 248, 0.4);
}

/* Tip Banner */
.tip-banner {
  position: absolute;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(56, 189, 248, 0.15);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(56, 189, 248, 0.3);
  border-radius: 12px;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 90%;
  z-index: 100;
  animation: slideDown 0.4s ease;
  box-shadow: 0 4px 20px rgba(56, 189, 248, 0.2);
}

.tip-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.tip-text {
  flex: 1;
  color: var(--accent);
  font-size: 0.9rem;
  line-height: 1.4;
}

.tip-close {
  background: none;
  border: none;
  color: var(--accent);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.7;
  transition: opacity 0.2s;
  flex-shrink: 0;
}

.tip-close:hover {
  opacity: 1;
}

/* Hint Button */
.hint-button {
  position: absolute;
  bottom: 60px;
  right: 20px;
  padding: 10px 16px;
  border-radius: 12px;
  border: 1px solid rgba(56, 189, 248, 0.3);
  background: rgba(56, 189, 248, 0.15);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: var(--accent);
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 50;
  display: flex;
  align-items: center;
  gap: 6px;
}

.hint-button:hover {
  background: rgba(56, 189, 248, 0.25);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
}

.hint-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Animations */
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@media screen and (max-width: 768px) {
  .tip-banner {
    top: 70px;
    padding: 10px 12px;
    font-size: 0.85rem;
  }
  
  .loading-screen {
    padding: 30px 20px;
  }
  
  .hint-button {
    bottom: 50px;
    right: 15px;
    padding: 8px 12px;
    font-size: 0.85rem;
  }
}
</style>
</head>
<body>

<div class="scene" id="scene">
  <div class="controls">
    <a href="../../categories.html" class="back-home">‚Üê Back to Categories</a>
    <div class="user-profile-btn" id="userProfileBtn" onclick="showUserProfile()">
      <span id="userIcon">üë§</span>
      <span id="userName">Guest</span>
    </div>
    
    <div class="progress-display" id="progressDisplay">
      <span>Level: <span id="userLevel">1</span></span>
      <span>GPA: <span id="userGPA">0.00</span></span>
    </div>
  </div>
  
  <div class="drop-zone" id="dropZone">
    <div class="drop-zone-text">Drop JSON file here to load custom scenarios</div>
  </div>

  <div class="card" id="card">
    <div class="face front">
      <div class="header">
        <button id="prevBtn" class="back-btn">‚Üê</button>
        <span id="qNum" class="qnum"></span>
      </div>
      <div id="timerContainer" style="display: none; position: absolute; top: 20px; right: 20px; z-index: 10;"></div>
      <div class="content" id="frontContent">
        <div id="scenarioContainer" style="display: none;"></div>
        <h2 id="qText"></h2>
        <div id="qImageContainer"></div>
        <div id="choices" class="choices"></div>
      </div>
      <button class="hint-button" id="hintButton" onclick="showHint()" style="display: none;">üí° Hint</button>
      <span class="hint">tap to reveal</span>
    </div>
    <div class="face back">
      <div class="content" id="backContent">
        <h2>Answer</h2>
        <div id="aImageContainer"></div>
        <p id="aText"></p>
      </div>
      <span class="hint">tap to continue</span>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal-overlay" id="successModal">
  <div class="modal">
    <div class="modal-icon">üéâ</div>
    <div class="modal-title">Excellent Work!</div>
    <div class="modal-message" id="modalMessage">Patient's condition is improving!</div>
    <button class="modal-button" onclick="closeSuccessModal()">Continue</button>
  </div>
</div>

<!-- Failure Modal -->
<div class="modal-overlay" id="failureModal">
  <div class="modal failure-modal">
    <div class="modal-icon">üíÄ</div>
    <div class="modal-title">Critical Error</div>
    <div class="modal-message" id="failureModalMessage">Patient's condition deteriorated!</div>
    <button class="modal-button failure-button" onclick="closeFailureModal()">Continue</button>
  </div>
</div>

<!-- Loading Screen with Tips -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-screen">
    <div class="loading-icon">‚è≥</div>
    <div class="loading-tip" id="loadingTip">Loading next scenario...</div>
    <div class="loading-progress" id="loadingProgress">Question 1 of 10</div>
    <button class="loading-continue-btn" id="loadingContinueBtn" onclick="hideLoadingScreen()">Continue</button>
  </div>
</div>

<!-- Tip Banner (Auto-display) -->
<div class="tip-banner" id="tipBanner" style="display: none;">
  <div class="tip-icon">üí°</div>
  <div class="tip-text" id="tipText"></div>
  <button class="tip-close" onclick="closeTipBanner()">√ó</button>
</div>

<!-- User Profile Modal -->
<div class="modal-overlay" id="userProfileModal" style="display: none;">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-title">User Profile & Settings</div>
    <div style="padding: 20px;">
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Name:</label>
        <input type="text" id="userNameInput" placeholder="Enter your name" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,.2); background: rgba(0,0,0,.3); color: #e5e7eb; font-size: 1rem;" />
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Icon (Emoji):</label>
        <input type="text" id="userIconInput" maxlength="2" placeholder="üë§" style="width: 100px; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,.2); background: rgba(0,0,0,.3); color: #e5e7eb; font-size: 1.5rem; text-align: center;" />
        <div style="font-size: 0.85rem; color: #9ca3af; margin-top: 5px;">Enter a single emoji (e.g., üë§ üéì üè•)</div>
      </div>
      <div style="margin-bottom: 20px; padding: 15px; background: rgba(56,189,248,.1); border-radius: 8px; border: 1px solid rgba(56,189,248,.2);">
        <div style="margin-bottom: 12px; font-weight: 600; color: var(--accent);"><strong>Progress Stats:</strong></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.95rem;">
          <div>Level: <span id="profileLevel" style="color: var(--accent); font-weight: 600;">1</span></div>
          <div>Total Questions: <span id="totalQuestions" style="color: var(--accent); font-weight: 600;">0</span></div>
          <div style="color: var(--good);">üíö Patients Saved: <span id="patientsSaved" style="color: var(--good); font-weight: 600;">0</span></div>
          <div style="color: var(--bad);">üíÄ Patients Lost: <span id="patientsLost" style="color: var(--bad); font-weight: 600;">0</span></div>
          <div>Correct Answers: <span id="totalCorrect" style="color: var(--good); font-weight: 600;">0</span></div>
          <div>GPA: <span id="profileGPA" style="color: var(--accent); font-weight: 600;">0.00</span></div>
          <div style="grid-column: 1 / -1;">Tests Completed: <span id="testsCompleted" style="color: var(--accent); font-weight: 600;">0</span></div>
        </div>
      </div>
      
      <!-- Danger Zone -->
      <div class="danger-zone" style="margin-top: 30px; padding: 20px; background: rgba(239,68,68,.15); border: 2px solid rgba(239,68,68,.5); border-radius: 8px;">
        <div style="color: #ef4444; font-weight: 600; font-size: 1.1rem; margin-bottom: 12px;">‚ö†Ô∏è DANGER ZONE</div>
        <div style="color: #fca5a5; font-size: 0.9rem; margin-bottom: 15px;">Clearing all data is permanent and cannot be undone. You will lose all progress, scores, and settings.</div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 8px; color: #fca5a5; font-weight: 600;">Re-enter your username to confirm:</label>
          <input type="text" id="confirmUsernameInput" placeholder="Type your username to confirm" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid rgba(239,68,68,.5); background: rgba(0,0,0,.4); color: #e5e7eb; font-size: 0.95rem;" />
        </div>
        <button id="clearDataBtn" class="danger-button" onclick="confirmClearData()" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ef4444; background: rgba(239,68,68,.2); color: #ef4444; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(239,68,68,.3)'; this.style.transform='scale(1.02)'" onmouseout="this.style.background='rgba(239,68,68,.2)'; this.style.transform='scale(1)'">Accept and Continue to Clear All Data</button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="modal-button" onclick="saveUserProfile()" style="flex: 1; padding: 12px;">Save Profile</button>
        <button class="modal-button failure-button" onclick="closeUserProfile()" style="flex: 1; padding: 12px; background: rgba(107,114,128,.2);">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Tone.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>

<script>
// ============================================================================
// TIPS DATA - Contextual tips for phlebotomy and general nursing
// ============================================================================
const phlebotomyTips = [
  "Remember: Some patients have thicker veins - consider using a butterfly needle (21-23 gauge)",
  "Slippery veins? Try warming the site with a warm compress or using a tourniquet",
  "Always verify patient identity using two identifiers before venipuncture",
  "For difficult draws, try the antecubital fossa (AC) or back of hand",
  "Blood cultures require sterile technique - clean site with chlorhexidine and allow to dry",
  "Order of draw matters! Follow CLSI guidelines: Blood cultures ‚Üí Blue ‚Üí Red ‚Üí Gold ‚Üí Green ‚Üí Lavender ‚Üí Gray",
  "Never touch the puncture site after cleaning - maintain sterile field",
  "Use a 30-45 degree angle for venipuncture, bevel up",
  "If blood flow stops, try rotating the needle slightly or adjusting depth",
  "Always anchor the vein below the puncture site to prevent rolling",
  "For patients with fragile veins, use a smaller gauge needle (23-25 gauge)",
  "Apply pressure for 2-3 minutes after draw, longer if patient is on anticoagulants",
  "Label tubes immediately at the bedside - never pre-label",
  "Mix additive tubes gently 5-10 times immediately after collection",
  "For blood cultures, collect aerobic bottle first, then anaerobic",
  "If you miss the vein, release tourniquet, apply pressure, and try the other arm",
  "Use safety needles to prevent needlestick injuries",
  "Dispose of sharps immediately in approved sharps container",
  "Wear appropriate PPE: gloves, and face shield if splash risk",
  "For pediatric patients, consider using smaller tubes and butterfly needles",
  "Check for allergies before using antiseptics (iodine, chlorhexidine)",
  "If patient is anxious, explain the procedure and use distraction techniques",
  "For patients with IVs, avoid drawing from the same arm if possible",
  "Always check tube expiration dates before use",
  "Transport specimens promptly - some tests require immediate processing"
];

const generalNursingTips = [
  "Double-check medication orders before administration",
  "Always use two patient identifiers when providing care",
  "Wash hands before and after every patient contact",
  "Document immediately after care - never document before providing it",
  "When in doubt, ask for clarification from supervisor or physician",
  "Patient safety is always the top priority",
  "Use teach-back method to verify patient understanding",
  "Report any abnormal findings immediately",
  "Maintain patient privacy and confidentiality at all times",
  "Stay current with evidence-based practice guidelines"
];

// ============================================================================
// FAILURE QUOTES - Motivational quotes for failure screen (COD-style)
// ============================================================================
const failureQuotes = [
  "In nursing, hesitation can mean the difference between life and death. Learn from this moment.",
  "Every mistake is a lesson. Every failure is a chance to grow stronger.",
  "The best nurses are forged in the fires of their mistakes. Rise from this.",
  "You failed today, but tomorrow you'll be better. That's what matters.",
  "A fallen comrade teaches us more than a thousand victories. Honor their memory by improving.",
  "The path to excellence is paved with failures. You're on the right path.",
  "This patient is gone, but the next one depends on what you learned here.",
  "Great nurses aren't born from success - they're forged from failure.",
  "Remember this moment. Let it drive you to never make this mistake again.",
  "The weight of a life lost is heavy, but it makes you stronger.",
  "You let one die, but you'll save hundreds because of what you learned.",
  "Failure is not the end - it's the beginning of wisdom.",
  "Every great nurse has lost patients. What matters is what you do next.",
  "This pain you feel? That's growth. Use it.",
  "The patient is gone, but their lesson lives on in you."
];

// ============================================================================
// SCENARIO DATA - ALL INLINE FOR EASY EDITING
// ============================================================================
// To add new scenarios, simply add a new entry to the flashcardDecks object below
// Format: Each deck needs: title, test, category, and cards array
// Each card needs: id, category, test, q (question), choices (array), correct (index), a (answer)
// Optional: image, answerImage (for images)
// Optional: scenario (text shown before question), timer (seconds), successMessage, failureMessage, causeOfDeath, timeoutMessage
// Optional: tips (array of tip indices from phlebotomyTips or generalNursingTips)
// ============================================================================

const flashcardDecks = {
  'phlebotomy': {
    "title": "Phlebotomy",
    "test": 1,
    "category": "Phlebotomy",
    "cards": [
      {
        "id": "q1",
        "category": "Phlebotomy",
        "test": 1,
        "scenario": "üö® CRITICAL: Patient presents with fever, chills, and suspected sepsis. You need to collect blood cultures immediately!",
        "timer": 20,
        "q": "What is the correct order for collecting blood culture bottles?",
        "choices": ["Aerobic bottle first, then anaerobic", "Anaerobic bottle first, then aerobic", "Order doesn't matter"],
        "correct": 0,
        "a": "Always collect the aerobic bottle first, then the anaerobic bottle. This prevents air from entering the anaerobic bottle, which could affect culture results.",
        "tips": [4],
        "successMessage": "‚úÖ Excellent! Blood cultures collected correctly. Patient's infection can now be properly identified.",
        "failureMessage": "üíÄ CRITICAL ERROR: Incorrect collection order may lead to false-negative results and delayed treatment!",
        "causeOfDeath": "Sepsis progression due to delayed diagnosis from contaminated blood cultures"
      },
      {
        "id": "q2",
        "category": "Phlebotomy",
        "test": 1,
        "scenario": "üö® EMERGENCY: Patient with suspected bacteremia requires blood culture collection. Time is critical!",
        "timer": 25,
        "q": "What antiseptic should be used for blood culture site preparation?",
        "choices": ["70% isopropyl alcohol only", "Chlorhexidine gluconate (CHG) 2% with 70% isopropyl alcohol", "Povidone-iodine only"],
        "correct": 1,
        "a": "For blood cultures, use chlorhexidine gluconate 2% with 70% isopropyl alcohol. Clean in a circular motion from center outward, allow to dry completely (30-60 seconds) before venipuncture.",
        "tips": [4, 20],
        "successMessage": "‚úÖ Perfect technique! Sterile field maintained. Risk of contamination minimized.",
        "failureMessage": "üíÄ CONTAMINATION: Improper site preparation led to false-positive culture results!"
      },
      {
        "id": "q3",
        "category": "Phlebotomy",
        "test": 1,
        "q": "How many blood culture sets should be collected from different sites for suspected bacteremia?",
        "choices": ["One set from one site", "Two sets from two different sites", "Three sets from the same site"],
        "correct": 1,
        "a": "Collect two blood culture sets from two different venipuncture sites. This helps distinguish true bacteremia from contamination and increases the likelihood of detecting pathogens.",
        "tips": [4],
        "successMessage": "‚úÖ Correct! Multiple sets improve diagnostic accuracy."
      },
      {
        "id": "q4",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What volume of blood should be collected for each blood culture bottle?",
        "choices": ["5-10 mL per bottle", "10-20 mL per bottle", "20-30 mL per bottle"],
        "correct": 1,
        "a": "Collect 10-20 mL of blood per bottle (adults). For pediatric patients, use smaller volumes based on weight. Adequate volume is critical for detecting low-level bacteremia.",
        "tips": [19],
        "successMessage": "‚úÖ Adequate volume collected for accurate culture results."
      },
      {
        "id": "q5",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the maximum time blood culture bottles should remain at room temperature before incubation?",
        "choices": ["2 hours", "4 hours", "8 hours"],
        "correct": 0,
        "a": "Blood culture bottles should be transported to the laboratory and incubated within 2 hours of collection. Delayed incubation may result in false-negative results.",
        "tips": [13],
        "successMessage": "‚úÖ Specimens transported promptly. Optimal culture conditions maintained."
      },
      {
        "id": "q6",
        "category": "Phlebotomy",
        "test": 1,
        "scenario": "üö® URGENT: Patient with suspected endocarditis needs blood cultures. Contamination could be fatal!",
        "timer": 30,
        "q": "What is the most common cause of blood culture contamination?",
        "choices": ["Insufficient blood volume", "Improper site preparation", "Using expired bottles"],
        "correct": 1,
        "a": "Improper site preparation is the most common cause of contamination. Inadequate cleaning allows skin flora (like coagulase-negative staphylococci) to enter the culture, leading to false-positive results.",
        "tips": [4, 6],
        "failureMessage": "üíÄ CONTAMINATION: False-positive results may lead to unnecessary antibiotic treatment and increased resistance!"
      },
      {
        "id": "q7",
        "category": "Phlebotomy",
        "test": 1,
        "q": "When should blood cultures be collected in relation to antibiotic administration?",
        "choices": ["Before antibiotics are given", "After antibiotics are given", "It doesn't matter"],
        "correct": 0,
        "a": "Blood cultures should be collected BEFORE antibiotics are administered whenever possible. Antibiotics can suppress bacterial growth, leading to false-negative culture results.",
        "tips": [13],
        "successMessage": "‚úÖ Cultures collected at optimal time for accurate results."
      },
      {
        "id": "q8",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if you accidentally touch the cleaned venipuncture site?",
        "choices": ["Continue with the draw", "Re-clean the site and allow to dry", "Use a different site"],
        "correct": 1,
        "a": "If the cleaned site is touched, you must re-clean the area with the antiseptic and allow it to dry completely (30-60 seconds) before proceeding. Touching contaminates the sterile field.",
        "tips": [6],
        "failureMessage": "üíÄ BREACH: Sterile technique compromised. Risk of contamination!"
      },
      {
        "id": "q9",
        "category": "Phlebotomy",
        "test": 1,
        "q": "For patients with suspected catheter-related bloodstream infection, where should blood cultures be drawn?",
        "choices": ["Only from the catheter", "From both the catheter and a peripheral site", "Only from a peripheral site"],
        "correct": 1,
        "a": "Collect blood cultures from both the catheter and a peripheral venipuncture site. This helps determine if the infection is catheter-related (catheter positive, peripheral negative) or systemic (both positive).",
        "tips": [22],
        "successMessage": "‚úÖ Proper sampling technique for accurate diagnosis."
      },
      {
        "id": "q10",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What information must be documented on blood culture bottle labels?",
        "choices": ["Patient name only", "Patient name, date, time, site, collector initials", "Patient name and date"],
        "correct": 1,
        "a": "Label bottles with patient name, date, time of collection, collection site (e.g., 'left AC'), and collector's initials. This ensures proper tracking and helps identify contamination sources.",
        "tips": [12],
        "successMessage": "‚úÖ Complete documentation ensures proper specimen tracking."
      },
      {
        "id": "q11",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the recommended time interval between blood culture collections?",
        "choices": ["Immediately one after another", "15-30 minutes apart", "Several hours apart"],
        "correct": 1,
        "a": "When collecting multiple sets, space them 15-30 minutes apart. This helps detect intermittent bacteremia and provides better diagnostic information than collecting all sets at once.",
        "tips": [4],
        "successMessage": "‚úÖ Proper timing improves diagnostic yield."
      },
      {
        "id": "q12",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if blood culture bottles are not immediately available after venipuncture?",
        "choices": ["Discard the blood and redraw", "Store blood in a regular tube temporarily", "Inject blood into bottles as soon as available"],
        "correct": 0,
        "a": "Never store blood for culture in regular tubes. If bottles aren't available, discard the blood and redraw when bottles are ready. Blood in regular tubes will clot and cannot be used for culture.",
        "tips": [13],
        "failureMessage": "üíÄ ERROR: Improper handling may result in unusable specimens and delayed diagnosis!"
      },
      {
        "id": "q13",
        "category": "Phlebotomy",
        "test": 1,
        "scenario": "üö® CRITICAL: Patient needs multiple lab tests. Incorrect order of draw could contaminate specimens!",
        "timer": 30,
        "q": "What is the correct CLSI order of draw for venipuncture?",
        "choices": ["Blood cultures ‚Üí Blue ‚Üí Red ‚Üí Gold ‚Üí Green ‚Üí Lavender ‚Üí Gray", "Red ‚Üí Blue ‚Üí Green ‚Üí Lavender ‚Üí Gray", "Blue ‚Üí Red ‚Üí Green ‚Üí Lavender"],
        "correct": 0,
        "a": "CLSI order: 1) Blood cultures, 2) Blue (sodium citrate), 3) Red/Gold (serum), 4) Green (heparin), 5) Lavender (EDTA), 6) Gray (oxalate/fluoride). This prevents cross-contamination of additives.",
        "tips": [5],
        "successMessage": "‚úÖ Perfect order! Specimens collected without contamination.",
        "failureMessage": "üíÄ CONTAMINATION: Incorrect order led to cross-contamination of additives and invalid test results!",
        "causeOfDeath": "Misdiagnosis due to contaminated lab results"
      },
      {
        "id": "q14",
        "category": "Phlebotomy",
        "test": 1,
        "q": "Why must blue-top tubes (sodium citrate) be drawn before red-top tubes?",
        "choices": ["Blue tubes need more blood", "To prevent tissue thromboplastin contamination from red tubes", "Blue tubes expire faster"],
        "correct": 1,
        "a": "Blue tubes must be drawn first to prevent contamination with tissue thromboplastin, which can be released when the needle enters the vein. This contamination would affect coagulation studies.",
        "tips": [5],
        "successMessage": "‚úÖ Coagulation studies protected from contamination."
      },
      {
        "id": "q15",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What happens if you draw a lavender (EDTA) tube before a red tube?",
        "choices": ["Nothing, order doesn't matter", "EDTA can contaminate the red tube, affecting chemistry tests", "Red tube will clot faster"],
        "correct": 1,
        "a": "EDTA from lavender tubes can contaminate subsequent tubes, causing falsely elevated potassium and falsely decreased calcium levels in chemistry tests. Always follow proper order of draw.",
        "tips": [5],
        "failureMessage": "üíÄ CONTAMINATION: EDTA contamination led to false lab values and potential misdiagnosis!"
      },
      {
        "id": "q16",
        "category": "Phlebotomy",
        "test": 1,
        "q": "How many times should you invert additive tubes after collection?",
        "choices": ["3-5 times", "5-10 times", "10-15 times"],
        "correct": 1,
        "a": "Gently invert additive tubes 5-10 times immediately after collection to ensure proper mixing of the additive with blood. Over-mixing can cause hemolysis.",
        "tips": [13],
        "successMessage": "‚úÖ Proper mixing ensures accurate test results."
      },
      {
        "id": "q17",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the purpose of the gray-top tube (sodium fluoride/potassium oxalate)?",
        "choices": ["Coagulation studies", "Glucose testing", "Complete blood count"],
        "correct": 1,
        "a": "Gray-top tubes contain sodium fluoride (preserves glucose) and potassium oxalate (anticoagulant). They are used for glucose tolerance tests and other tests requiring preserved glucose levels.",
        "tips": [5],
        "successMessage": "‚úÖ Correct tube selection for glucose testing."
      },
      {
        "id": "q18",
        "category": "Phlebotomy",
        "test": 1,
        "q": "If you only need to collect a red-top tube and a lavender tube, which should be drawn first?",
        "choices": ["Red first", "Lavender first", "Order doesn't matter"],
        "correct": 0,
        "a": "Always draw red-top tubes before lavender (EDTA) tubes to prevent EDTA contamination of chemistry tests, even when only collecting a few tubes.",
        "tips": [5],
        "successMessage": "‚úÖ Proper order maintained even with limited draws."
      },
      {
        "id": "q19",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if you accidentally draw tubes in the wrong order?",
        "choices": ["Continue and use the specimens", "Discard all tubes and redraw", "Use only the first tube"],
        "correct": 1,
        "a": "If order of draw is incorrect, discard all affected tubes and redraw using proper order. Contaminated specimens can lead to inaccurate results and misdiagnosis.",
        "tips": [5],
        "failureMessage": "üíÄ ERROR: Using contaminated specimens could lead to incorrect treatment decisions!"
      },
      {
        "id": "q20",
        "category": "Phlebotomy",
        "test": 1,
        "q": "Why are blood cultures always drawn first in the order of draw?",
        "choices": ["They need the most blood", "To prevent contamination from other tube additives", "They're the most important tests"],
        "correct": 1,
        "a": "Blood cultures are drawn first to prevent contamination from additives in other tubes (like EDTA, heparin, or citrate) that could interfere with bacterial growth and lead to false-negative results.",
        "tips": [4, 5],
        "successMessage": "‚úÖ Cultures protected from additive contamination."
      },
      {
        "id": "q21",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the minimum volume required for a blue-top (sodium citrate) tube?",
        "choices": ["50% fill", "90% fill", "100% fill"],
        "correct": 1,
        "a": "Blue-top tubes must be filled to at least 90% capacity. Underfilling causes an incorrect blood-to-additive ratio, leading to falsely prolonged coagulation times.",
        "tips": [5],
        "failureMessage": "üíÄ ERROR: Underfilled tube led to incorrect coagulation results and potential bleeding risk misassessment!"
      },
      {
        "id": "q22",
        "category": "Phlebotomy",
        "test": 1,
        "q": "Can you use a butterfly needle for order of draw?",
        "choices": ["Yes, order still applies", "No, order doesn't matter with butterflies", "Butterflies can't be used for multiple tubes"],
        "correct": 0,
        "a": "Yes, the order of draw must still be followed when using a butterfly needle. The same contamination risks apply regardless of needle type.",
        "tips": [0, 10],
        "successMessage": "‚úÖ Proper technique maintained with butterfly needle."
      },
      {
        "id": "q23",
        "category": "Phlebotomy",
        "test": 1,
        "scenario": "üö® CHALLENGE: Patient has difficult veins. You need to select the right technique!",
        "timer": 25,
        "q": "What angle should the needle be inserted for venipuncture?",
        "choices": ["15-30 degrees", "30-45 degrees", "60-90 degrees"],
        "correct": 1,
        "a": "Insert the needle at a 30-45 degree angle with the bevel up. This angle allows proper entry into the vein while minimizing the risk of going through the vein.",
        "tips": [7],
        "successMessage": "‚úÖ Perfect angle! Successful venipuncture achieved.",
        "failureMessage": "üíÄ TECHNIQUE ERROR: Incorrect angle led to failed venipuncture and patient discomfort!"
      },
      {
        "id": "q24",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if blood flow stops during collection?",
        "choices": ["Remove the needle immediately", "Push the needle deeper", "Gently rotate or adjust the needle slightly"],
        "correct": 2,
        "a": "If blood flow stops, the needle may have moved. Gently rotate the needle slightly or adjust the depth. Never push deeper aggressively as this can cause pain and hematoma.",
        "tips": [8],
        "successMessage": "‚úÖ Flow restored with gentle adjustment."
      },
      {
        "id": "q25",
        "category": "Phlebotomy",
        "test": 1,
        "q": "How long should a tourniquet remain in place?",
        "choices": ["No time limit", "Maximum 1 minute", "Maximum 2 minutes"],
        "correct": 1,
        "a": "Tourniquet should remain in place for a maximum of 1 minute. Prolonged tourniquet time can cause hemoconcentration, affecting test results, and patient discomfort.",
        "tips": [1],
        "successMessage": "‚úÖ Tourniquet used appropriately."
      },
      {
        "id": "q26",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the best site for venipuncture in most adults?",
        "choices": ["Wrist", "Antecubital fossa (AC)", "Back of hand"],
        "correct": 1,
        "a": "The antecubital fossa (inner elbow) is the preferred site for venipuncture in adults. It typically has larger, more stable veins (median cubital, cephalic, or basilic).",
        "tips": [3],
        "successMessage": "‚úÖ Optimal site selected for successful draw."
      },
      {
        "id": "q27",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do to anchor a vein before venipuncture?",
        "choices": ["Pull the skin taut above the site", "Pull the skin taut below the site", "Don't anchor, just insert"],
        "correct": 1,
        "a": "Anchor the vein by pulling the skin taut BELOW the puncture site with your non-dominant hand. This stabilizes the vein and prevents it from rolling during needle insertion.",
        "tips": [9],
        "successMessage": "‚úÖ Vein properly anchored for stable venipuncture."
      },
      {
        "id": "q28",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if you miss the vein on the first attempt?",
        "choices": ["Try again immediately in the same spot", "Release tourniquet, apply pressure, try other arm", "Dig around to find the vein"],
        "correct": 1,
        "a": "If you miss the vein, release the tourniquet, apply pressure to the site, and attempt venipuncture on the other arm. Never probe or dig with the needle as this causes pain and tissue damage.",
        "tips": [15],
        "failureMessage": "üíÄ TECHNIQUE ERROR: Multiple failed attempts caused patient trauma and hematoma formation!"
      },
      {
        "id": "q29",
        "category": "Phlebotomy",
        "test": 1,
        "q": "How should you position the patient's arm for venipuncture?",
        "choices": ["Arm hanging down", "Arm extended with slight downward angle", "Arm elevated above heart"],
        "correct": 1,
        "a": "Position the arm extended with a slight downward angle. This position promotes venous filling and makes the veins more visible and accessible.",
        "tips": [3],
        "successMessage": "‚úÖ Optimal positioning for successful venipuncture."
      },
      {
        "id": "q30",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the recommended technique for removing the tourniquet?",
        "choices": ["Remove immediately after needle insertion", "Remove after first tube starts filling", "Leave on until all tubes are filled"],
        "correct": 1,
        "a": "Remove the tourniquet after the first tube begins to fill. This prevents hemoconcentration while ensuring adequate blood flow for collection.",
        "tips": [1],
        "successMessage": "‚úÖ Tourniquet removed at optimal time."
      },
      {
        "id": "q31",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if a patient has a history of difficult venipuncture?",
        "choices": ["Use the same technique as always", "Consider warming the site, using smaller gauge needle, or butterfly", "Use a larger gauge needle"],
        "correct": 1,
        "a": "For difficult venipunctures, try warming the site with a warm compress, using a smaller gauge needle (23-25g), or a butterfly needle. These techniques can improve success rates.",
        "tips": [0, 1, 10],
        "successMessage": "‚úÖ Alternative techniques used successfully."
      },
      {
        "id": "q32",
        "category": "Phlebotomy",
        "test": 1,
        "q": "How long should you apply pressure after venipuncture?",
        "choices": ["30 seconds", "2-3 minutes", "5 minutes"],
        "correct": 1,
        "a": "Apply direct pressure for 2-3 minutes after venipuncture, or longer if the patient is on anticoagulants. This prevents hematoma formation and bleeding.",
        "tips": [11],
        "successMessage": "‚úÖ Adequate pressure applied to prevent complications."
      },
      {
        "id": "q33",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the maximum number of venipuncture attempts you should make?",
        "choices": ["2 attempts", "3 attempts", "No limit"],
        "correct": 0,
        "a": "Limit venipuncture attempts to 2 per phlebotomist. If unsuccessful after 2 attempts, have another qualified person try or consider alternative collection methods.",
        "tips": [15],
        "failureMessage": "üíÄ ERROR: Excessive attempts caused patient trauma. Alternative approach needed!"
      },
      {
        "id": "q34",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you check before performing venipuncture?",
        "choices": ["Patient identity only", "Patient identity, allergies, and site condition", "Just the site condition"],
        "correct": 1,
        "a": "Before venipuncture, verify patient identity using two identifiers, check for allergies (especially to antiseptics), and assess the site for conditions like IVs, edema, or previous hematomas.",
        "tips": [2, 20],
        "successMessage": "‚úÖ Proper pre-procedure assessment completed."
      },
      {
        "id": "q35",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if a patient becomes lightheaded during venipuncture?",
        "choices": ["Continue quickly", "Stop immediately, lower patient's head, monitor", "Tell them to look away"],
        "correct": 1,
        "a": "If a patient becomes lightheaded, stop the procedure immediately, lower the patient's head (or have them sit with head between knees), monitor vital signs, and ensure safety. Never leave a syncopal patient unattended.",
        "tips": [21],
        "failureMessage": "üíÄ COMPLICATION: Patient injury due to syncope during procedure!"
      },
      {
        "id": "q36",
        "category": "Phlebotomy",
        "test": 1,
        "scenario": "üö® DECISION: Patient has small, fragile veins. You need to select the right equipment!",
        "timer": 20,
        "q": "When should you use a butterfly needle instead of a straight needle?",
        "choices": ["Always use butterfly", "For difficult veins, small veins, or hand draws", "Never use butterfly"],
        "correct": 1,
        "a": "Use a butterfly needle (21-23 gauge) for difficult veins, small or fragile veins, hand draws, or when better control is needed. The shorter needle and flexible tubing provide better maneuverability.",
        "tips": [0, 10],
        "successMessage": "‚úÖ Appropriate needle selection for patient condition.",
        "failureMessage": "üíÄ EQUIPMENT ERROR: Wrong needle choice led to failed venipuncture and patient discomfort!"
      },
      {
        "id": "q37",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What gauge needle is typically used for routine venipuncture in adults?",
        "choices": ["18-19 gauge", "20-22 gauge", "25-27 gauge"],
        "correct": 1,
        "a": "20-22 gauge needles are standard for routine adult venipuncture. Larger gauges (18-19) may be used for rapid collection, while smaller (23-25) are used for fragile veins.",
        "tips": [0, 10],
        "successMessage": "‚úÖ Appropriate gauge selected for routine collection."
      },
      {
        "id": "q38",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the advantage of safety needles?",
        "choices": ["They're sharper", "They reduce needlestick injury risk", "They're cheaper"],
        "correct": 1,
        "a": "Safety needles have built-in safety mechanisms (like retractable needles or shields) that activate after use, significantly reducing the risk of needlestick injuries and bloodborne pathogen exposure.",
        "tips": [16],
        "successMessage": "‚úÖ Safety equipment protects healthcare workers."
      },
      {
        "id": "q39",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What type of tube is used for complete blood count (CBC)?",
        "choices": ["Red-top (serum)", "Lavender-top (EDTA)", "Green-top (heparin)"],
        "correct": 1,
        "a": "Lavender-top tubes contain EDTA (ethylenediaminetetraacetic acid), which is the anticoagulant of choice for CBC and most hematology tests. EDTA preserves cell morphology.",
        "tips": [5],
        "successMessage": "‚úÖ Correct tube for hematology testing."
      },
      {
        "id": "q40",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the purpose of the gel separator in gold-top (SST) tubes?",
        "choices": ["Prevents clotting", "Separates serum from cells after centrifugation", "Preserves glucose"],
        "correct": 1,
        "a": "Gold-top tubes (serum separator tubes) contain a gel that separates serum from cells after centrifugation. This allows serum to be easily removed without cell contamination.",
        "tips": [5],
        "successMessage": "‚úÖ Proper tube for serum chemistry tests."
      },
      {
        "id": "q41",
        "category": "Phlebotomy",
        "test": 1,
        "q": "When should you use a winged infusion set (butterfly) with a syringe instead of evacuated tubes?",
        "choices": ["Never", "For small volume draws or difficult veins", "Always"],
        "correct": 1,
        "a": "Use a butterfly with syringe for small volume collections, difficult veins, or when precise volume control is needed. The syringe allows better control of negative pressure.",
        "tips": [0, 10],
        "successMessage": "‚úÖ Appropriate technique for challenging draws."
      },
      {
        "id": "q42",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you check on blood collection tubes before use?",
        "choices": ["Color only", "Expiration date and integrity", "Just the color and size"],
        "correct": 1,
        "a": "Always check tube expiration date and inspect for cracks, defects, or compromised vacuum. Expired or damaged tubes can lead to inaccurate results or collection failure.",
        "tips": [23],
        "successMessage": "‚úÖ Tubes verified before use."
      },
      {
        "id": "q43",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What gauge needle is recommended for pediatric venipuncture?",
        "choices": ["18-20 gauge", "21-25 gauge", "Same as adults"],
        "correct": 1,
        "a": "Use smaller gauge needles (21-25 gauge) for pediatric patients. Smaller needles cause less trauma and are more appropriate for smaller veins. Butterfly needles are often preferred.",
        "tips": [10, 19],
        "successMessage": "‚úÖ Age-appropriate equipment selected."
      },
      {
        "id": "q44",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the difference between a multi-sample needle and a single-sample needle?",
        "choices": ["Multi-sample has a retractable point", "Multi-sample allows multiple tubes without removing needle", "There's no difference"],
        "correct": 1,
        "a": "Multi-sample needles have a rubber sleeve that covers the needle point when not in use, allowing multiple tubes to be attached without removing the needle from the vein. Single-sample needles are removed after each tube.",
        "tips": [5],
        "successMessage": "‚úÖ Appropriate needle type for multiple tube collection."
      },
      {
        "id": "q45",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if a tube loses its vacuum?",
        "choices": ["Use it anyway", "Discard and use a new tube", "Shake it to restore vacuum"],
        "correct": 1,
        "a": "If a tube loses its vacuum, discard it and use a new tube. Tubes without proper vacuum will not fill correctly, leading to incorrect blood-to-additive ratios and inaccurate results.",
        "tips": [23],
        "failureMessage": "üíÄ EQUIPMENT FAILURE: Using compromised tube led to incorrect test results!"
      },
      {
        "id": "q46",
        "category": "Phlebotomy",
        "test": 1,
        "q": "When should blood collection tubes be labeled?",
        "choices": ["Before collection", "Immediately after collection at the bedside", "After leaving the patient's room"],
        "correct": 1,
        "a": "Label tubes immediately after collection at the patient's bedside. Never pre-label tubes or label them away from the patient, as this increases the risk of mislabeling and specimen mix-ups.",
        "tips": [12],
        "successMessage": "‚úÖ Proper labeling prevents specimen errors.",
        "failureMessage": "üíÄ CRITICAL ERROR: Mislabeled specimen could lead to wrong patient receiving incorrect treatment!"
      },
      {
        "id": "q47",
        "category": "Phlebotomy",
        "test": 1,
        "q": "How should specimens be transported to the laboratory?",
        "choices": ["Any container", "In appropriate transport containers with proper temperature control", "Carried in hand"],
        "correct": 1,
        "a": "Transport specimens in appropriate containers that maintain proper temperature and protect from breakage. Some tests require immediate transport, while others can be stored temporarily under specific conditions.",
        "tips": [13],
        "successMessage": "‚úÖ Specimens transported under optimal conditions."
      },
      {
        "id": "q48",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What information must be on every specimen label?",
        "choices": ["Patient name only", "Patient name, date, time, collector ID", "Just patient name and date"],
        "correct": 1,
        "a": "Labels must include patient name (or unique identifier), date and time of collection, and collector's identification. Some facilities also require patient date of birth or medical record number.",
        "tips": [12],
        "successMessage": "‚úÖ Complete labeling ensures proper specimen identification."
      },
      {
        "id": "q49",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if you notice hemolysis in a collected specimen?",
        "choices": ["Use it anyway", "Discard and redraw if possible", "Send it with a note"],
        "correct": 1,
        "a": "If hemolysis is visible, discard the specimen and redraw if possible. Hemolyzed specimens can cause inaccurate results for many tests (especially potassium, LDH, and some enzymes).",
        "tips": [13],
        "failureMessage": "üíÄ SPECIMEN QUALITY: Hemolyzed specimen led to false lab values and potential misdiagnosis!"
      },
      {
        "id": "q50",
        "category": "Phlebotomy",
        "test": 1,
        "q": "How should tubes be stored if they cannot be processed immediately?",
        "choices": ["Room temperature always", "According to test requirements (some need refrigeration, some room temp)", "In the freezer"],
        "correct": 1,
        "a": "Storage depends on test requirements. Most chemistry tests can be stored at room temperature, but some require refrigeration. Always follow laboratory-specific storage guidelines for each test type.",
        "tips": [13],
        "successMessage": "‚úÖ Proper storage maintains specimen integrity."
      },
      {
        "id": "q51",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the maximum time most serum specimens can remain at room temperature before processing?",
        "choices": ["1 hour", "2 hours", "4 hours"],
        "correct": 1,
        "a": "Most serum specimens should be processed within 2 hours of collection. Prolonged storage at room temperature can cause changes in analyte concentrations and affect test accuracy.",
        "tips": [13],
        "successMessage": "‚úÖ Timely processing ensures accurate results."
      },
      {
        "id": "q52",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if a specimen tube breaks during transport?",
        "choices": ["Collect the blood from the container", "Discard safely, notify lab, redraw if needed", "Try to salvage what you can"],
        "correct": 1,
        "a": "If a tube breaks, safely discard it following biohazard protocols, notify the laboratory, and redraw if the test is still needed. Never attempt to salvage blood from a broken container due to contamination risk.",
        "tips": [13, 17],
        "failureMessage": "üíÄ SAFETY BREACH: Improper handling of broken tube created contamination risk!"
      },
      {
        "id": "q53",
        "category": "Phlebotomy",
        "test": 1,
        "q": "Why should you not shake blood collection tubes vigorously?",
        "choices": ["It doesn't matter", "It can cause hemolysis", "Tubes might break"],
        "correct": 1,
        "a": "Vigorous shaking can cause hemolysis (red blood cell rupture), which releases intracellular contents and can falsely elevate certain analytes like potassium, LDH, and AST.",
        "tips": [13],
        "failureMessage": "üíÄ SPECIMEN DAMAGE: Hemolysis from rough handling led to inaccurate results!"
      },
      {
        "id": "q54",
        "category": "Phlebotomy",
        "test": 1,
        "scenario": "üö® SAFETY: Patient has known bloodborne pathogen. You must follow strict safety protocols!",
        "timer": 25,
        "q": "What personal protective equipment (PPE) is required for venipuncture?",
        "choices": ["Gloves only", "Gloves, and face shield if splash risk", "No PPE needed if careful"],
        "correct": 1,
        "a": "Wear gloves for all venipunctures. Add a face shield or mask with eye protection if there's a risk of blood splashes or if the patient is coughing. Standard precautions apply to all patients.",
        "tips": [17],
        "successMessage": "‚úÖ Proper PPE protects you and the patient.",
        "failureMessage": "üíÄ EXPOSURE RISK: Inadequate PPE created risk of bloodborne pathogen exposure!",
        "causeOfDeath": "Healthcare worker exposure to bloodborne pathogens"
      },
      {
        "id": "q55",
        "category": "Phlebotomy",
        "test": 1,
        "q": "How should used needles be disposed of?",
        "choices": ["In regular trash", "Immediately in approved sharps container", "Save for later disposal"],
        "correct": 1,
        "a": "Dispose of used needles immediately in an approved, puncture-resistant sharps container. Never recap, bend, or break needles. Place the container within arm's reach during the procedure.",
        "tips": [16, 17],
        "successMessage": "‚úÖ Proper sharps disposal prevents injuries."
      },
      {
        "id": "q56",
        "category": "Phlebotomy",
        "test": 1,
        "q": "When should hand hygiene be performed during phlebotomy?",
        "choices": ["Before procedure only", "Before and after procedure, and after removing gloves", "After procedure only"],
        "correct": 1,
        "a": "Perform hand hygiene before the procedure, after removing gloves, and whenever hands become contaminated. Hand hygiene is critical for preventing healthcare-associated infections.",
        "tips": [2],
        "successMessage": "‚úÖ Proper hand hygiene prevents infection transmission."
      },
      {
        "id": "q57",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if you experience a needlestick injury?",
        "choices": ["Ignore it if no blood", "Wash area, report immediately, follow facility protocol", "Just wash and continue"],
        "correct": 1,
        "a": "If a needlestick occurs: 1) Wash the area with soap and water, 2) Report immediately to supervisor and employee health, 3) Follow facility's exposure control protocol, which may include baseline testing and post-exposure prophylaxis.",
        "tips": [16, 17],
        "failureMessage": "üíÄ EXPOSURE: Delayed reporting of needlestick may delay appropriate treatment!"
      },
      {
        "id": "q58",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What is the purpose of standard precautions?",
        "choices": ["Only for known infectious patients", "Apply to all patients to prevent disease transmission", "Only for blood draws"],
        "correct": 1,
        "a": "Standard precautions apply to ALL patients regardless of known infection status. They include hand hygiene, PPE use, safe injection practices, and proper handling of potentially infectious materials.",
        "tips": [17],
        "successMessage": "‚úÖ Standard precautions protect everyone."
      },
      {
        "id": "q59",
        "category": "Phlebotomy",
        "test": 1,
        "q": "How should you handle a patient who is coughing during venipuncture?",
        "choices": ["Continue as normal", "Wear additional PPE (mask/face shield), have patient cover mouth", "Refuse to draw"],
        "correct": 1,
        "a": "If a patient is coughing, wear additional PPE (surgical mask or face shield), have the patient cover their mouth, and consider droplet precautions. Never refuse care, but take appropriate protective measures.",
        "tips": [17],
        "successMessage": "‚úÖ Additional precautions taken for respiratory protection."
      },
      {
        "id": "q60",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if blood splashes on your skin during venipuncture?",
        "choices": ["Wipe it off and continue", "Wash area immediately with soap and water, report if exposure protocol applies", "Ignore it"],
        "correct": 1,
        "a": "If blood contacts non-intact skin or mucous membranes, wash the area immediately with soap and water, and follow your facility's blood exposure protocol. Report to supervisor if required.",
        "tips": [17],
        "failureMessage": "üíÄ EXPOSURE: Improper handling of blood contact created infection risk!"
      },
      {
        "id": "q61",
        "category": "Phlebotomy",
        "test": 1,
        "q": "Why should you never recap a used needle?",
        "choices": ["It's wasteful", "Recapping increases needlestick injury risk", "Needles can't be recapped"],
        "correct": 1,
        "a": "Never recap used needles because recapping is a leading cause of needlestick injuries. Use safety needles or dispose directly into sharps containers. If recapping is absolutely necessary, use a one-handed scoop technique.",
        "tips": [16, 17],
        "successMessage": "‚úÖ Safe disposal practice prevents injuries."
      },
      {
        "id": "q62",
        "category": "Phlebotomy",
        "test": 1,
        "q": "What should you do if a sharps container is full?",
        "choices": ["Force more items in", "Close and replace with new container, follow disposal protocol", "Leave items on counter"],
        "correct": 1,
        "a": "When a sharps container is 3/4 full, close it securely and replace with a new container. Follow your facility's protocol for proper disposal of filled sharps containers. Never overfill.",
        "tips": [17],
        "successMessage": "‚úÖ Proper sharps container management prevents injuries."
      }
    ]
  }
};

// ============================================================================
// END OF SCENARIO DATA
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
  const card = document.getElementById('card');
  const qText = document.getElementById('qText');
  const aText = document.getElementById('aText');
  const qNum = document.getElementById('qNum');
  const prevBtn = document.getElementById('prevBtn');
  const choicesEl = document.getElementById('choices');
  const dropZone = document.getElementById('dropZone');
  const scene = document.getElementById('scene');
  const frontContent = document.getElementById('frontContent');
  const backContent = document.getElementById('backContent');
  const qImageContainer = document.getElementById('qImageContainer');
  const aImageContainer = document.getElementById('aImageContainer');
  const scenarioContainer = document.getElementById('scenarioContainer');
  const timerContainer = document.getElementById('timerContainer');
  const successModal = document.getElementById('successModal');
  const modalMessage = document.getElementById('modalMessage');
  const failureModal = document.getElementById('failureModal');
  const failureModalMessage = document.getElementById('failureModalMessage');

  let deck = [];
  let deckTitle = '';
  let index = 0;
  let showingAnswer = false;
  let score = 0;
  let selected = null;
  let completed = false;
  let timerInterval = null;
  let timeRemaining = 0;
  let timedOut = false;
  let hintsUsed = 0;
  const maxHintsPerQuestion = 3;
  let currentTips = [];

  // Load available categories from inline data (not used on category pages, but kept for compatibility)
  function loadCategories() {
    // Category pages auto-load their specific deck, so this is not needed
    // But kept for drag-and-drop compatibility
  }

  // Load deck from inline data or file
  function loadDeck(deckKey) {
    // Check if user has a name - required to use app
    const userData = getUserData();
    if (!userData || !userData.name || userData.name.trim() === '') {
      // No name - show profile modal
      showUserProfile();
      return;
    }
    
    console.log('Loading deck:', deckKey);
    
    // Check if it's an inline deck
    if (flashcardDecks[deckKey]) {
      const data = flashcardDecks[deckKey];
      deck = data.cards || [];
      deckTitle = data.title || 'Quiz';
      
      if (deck.length === 0) {
        showError('No cards found in deck');
        return;
      }
      
      index = 0;
      score = 0;
      completed = false;
      showingAnswer = false;
      card.classList.remove('is-flipped');
      renderQuestion();
      return;
    }
    
    // If not found, try to load from file (for drag-and-drop)
    showError('Deck not found. Use drag-and-drop to load a file.');
  }


  // Load deck from file content (JSON only) - for drag-and-drop
  function loadDeckFromFile(fileContent, fileName = '') {
    try {
      const data = JSON.parse(fileContent);
      if (!data.cards || data.cards.length === 0) {
        throw new Error('No cards found in file');
      }
      deck = data.cards;
      deckTitle = data.title || 'Custom Deck';
      index = 0;
      score = 0;
      completed = false;
      showingAnswer = false;
      card.classList.remove('is-flipped');
      renderQuestion();
    } catch (e) {
      showError('Invalid JSON file: ' + e.message);
    }
  }

  function showError(msg) {
    frontContent.innerHTML = `<div class="error">${msg}</div>`;
    backContent.innerHTML = '';
  }

  function showLoading() {
    frontContent.innerHTML = '<div class="loading">Loading scenarios...</div>';
    backContent.innerHTML = '';
  }

  // Tips and Loading Screen Functions
  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingTip = document.getElementById('loadingTip');
  const loadingProgress = document.getElementById('loadingProgress');
  const tipBanner = document.getElementById('tipBanner');
  const tipText = document.getElementById('tipText');
  const hintButton = document.getElementById('hintButton');
  const failureScreen = document.getElementById('failureScreen');
  const failureQuote = document.getElementById('failureQuote');
  
  // User Profile Elements
  const userProfileModal = document.getElementById('userProfileModal');
  const userNameDisplay = document.getElementById('userName');
  const userIconDisplay = document.getElementById('userIcon');
  const userNameInput = document.getElementById('userNameInput');
  const userIconInput = document.getElementById('userIconInput');
  const confirmUsernameInput = document.getElementById('confirmUsernameInput');
  const clearDataBtn = document.getElementById('clearDataBtn');
  
  // User Profile Data Storage
  function getUserData() {
    try {
      const stored = localStorage.getItem('fif_lod_userData');
      if (stored) return JSON.parse(stored);
    } catch (e) {
      console.log('localStorage not available:', e);
    }
    try {
      const sessionStored = sessionStorage.getItem('fif_lod_userData');
      if (sessionStored) return JSON.parse(sessionStored);
    } catch (e) {
      console.log('sessionStorage not available:', e);
    }
    const cookieData = getCookie('fif_lod_userData');
    if (cookieData) {
      try {
        return JSON.parse(cookieData);
      } catch (e) {
        console.log('Cookie parse error:', e);
      }
    }
    return null;
  }
  
  function saveUserData(data) {
    const dataStr = JSON.stringify(data);
    try {
      localStorage.setItem('fif_lod_userData', dataStr);
    } catch (e) {
      console.log('localStorage save failed:', e);
    }
    try {
      sessionStorage.setItem('fif_lod_userData', dataStr);
    } catch (e) {
      console.log('sessionStorage save failed:', e);
    }
    setCookie('fif_lod_userData', dataStr, 365);
  }
  
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
  
  function setCookie(name, value, days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    const expires = `expires=${date.toUTCString()}`;
    document.cookie = `${name}=${value};${expires};path=/`;
  }
  
  function clearAllData() {
    try {
      localStorage.removeItem('fif_lod_userData');
      localStorage.removeItem('fif_lod_progress');
      localStorage.clear();
    } catch (e) {
      console.log('localStorage clear failed:', e);
    }
    try {
      sessionStorage.removeItem('fif_lod_userData');
      sessionStorage.removeItem('fif_lod_progress');
      sessionStorage.clear();
    } catch (e) {
      console.log('sessionStorage clear failed:', e);
    }
    document.cookie = 'fif_lod_userData=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;';
    document.cookie = 'fif_lod_progress=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;';
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          caches.delete(name);
        });
      });
    }
  }
  
  function loadUserData() {
    const userData = getUserData();
    if (userData && userData.name && userData.name.trim() !== '') {
      if (userNameDisplay) userNameDisplay.textContent = userData.name;
      if (userIconDisplay) userIconDisplay.textContent = userData.icon || 'üë§';
      if (userNameInput) userNameInput.value = userData.name;
      if (userIconInput) userIconInput.value = userData.icon || 'üë§';
      updateProgressDisplay(userData);
    } else {
      if (userNameDisplay) userNameDisplay.textContent = 'Guest';
      if (userIconDisplay) userIconDisplay.textContent = 'üë§';
      if (userNameInput) userNameInput.value = '';
      if (userIconInput) userIconInput.value = 'üë§';
      setTimeout(() => {
        if (userProfileModal) {
          userProfileModal.style.display = 'grid';
          userProfileModal.classList.add('show');
        }
      }, 500);
    }
  }
  
  function updateProgressDisplay(userData) {
    const progress = userData.progress || {};
    const patientsSaved = progress.patientsSaved || 0;
    const patientsLost = progress.patientsLost || 0;
    if (document.getElementById('profileLevel')) {
      document.getElementById('profileLevel').textContent = progress.level || 1;
    }
    if (document.getElementById('totalQuestions')) {
      document.getElementById('totalQuestions').textContent = progress.totalQuestions || 0;
    }
    if (document.getElementById('totalCorrect')) {
      document.getElementById('totalCorrect').textContent = progress.totalCorrect || 0;
    }
    if (document.getElementById('profileGPA')) {
      const gpa = progress.totalQuestions > 0 ? (progress.totalCorrect / progress.totalQuestions * 4).toFixed(2) : '0.00';
      document.getElementById('profileGPA').textContent = gpa;
    }
    if (document.getElementById('testsCompleted')) {
      document.getElementById('testsCompleted').textContent = progress.testsCompleted || 0;
    }
    if (document.getElementById('patientsSaved')) {
      document.getElementById('patientsSaved').textContent = patientsSaved;
    }
    if (document.getElementById('patientsLost')) {
      document.getElementById('patientsLost').textContent = patientsLost;
    }
    if (document.getElementById('userLevel')) {
      document.getElementById('userLevel').textContent = progress.level || 1;
    }
    if (document.getElementById('userGPA')) {
      const gpa = progress.totalQuestions > 0 ? (progress.totalCorrect / progress.totalQuestions * 4).toFixed(2) : '0.00';
      document.getElementById('userGPA').textContent = gpa;
    }
  }
  
  window.showUserProfile = function() {
    if (!userProfileModal) return;
    const userData = getUserData();
    if (userData) {
      if (userNameInput) userNameInput.value = userData.name || '';
      if (userIconInput) userIconInput.value = userData.icon || 'üë§';
      updateProgressDisplay(userData);
    } else {
      if (userNameInput) userNameInput.value = '';
      if (userIconInput) userIconInput.value = 'üë§';
    }
    if (userProfileModal.classList.contains('show')) {
      closeUserProfile();
    } else {
      userProfileModal.style.display = 'grid';
      userProfileModal.classList.add('show');
    }
  };
  
  window.saveUserProfile = function() {
    const name = userNameInput ? userNameInput.value.trim() : '';
    const icon = userIconInput ? userIconInput.value.trim() : 'üë§';
    if (!name) {
      alert('Please enter your name! A name is required to use the app.');
      return;
    }
    const userData = getUserData() || {};
    userData.name = name;
    userData.icon = icon || 'üë§';
    userData.progress = userData.progress || {
      level: 1,
      totalQuestions: 0,
      totalCorrect: 0,
      testsCompleted: 0,
      patientsSaved: 0,
      patientsLost: 0
    };
    saveUserData(userData);
    if (userNameDisplay) userNameDisplay.textContent = name;
    if (userIconDisplay) userIconDisplay.textContent = icon || 'üë§';
    updateProgressDisplay(userData);
    closeUserProfile();
  };
  
  window.closeUserProfile = function() {
    if (!userProfileModal) return;
    userProfileModal.classList.remove('show');
    setTimeout(() => {
      userProfileModal.style.display = 'none';
      if (confirmUsernameInput) confirmUsernameInput.value = '';
    }, 300);
  };
  
  window.confirmClearData = function() {
    if (!confirmUsernameInput || !clearDataBtn) return;
    const userData = getUserData();
    const currentUsername = userData ? userData.name : '';
    const enteredUsername = confirmUsernameInput.value.trim();
    if (!enteredUsername) {
      alert('Please enter your username to confirm!');
      return;
    }
    if (enteredUsername !== currentUsername) {
      alert('Username does not match! Please enter your exact username to confirm deletion.');
      confirmUsernameInput.value = '';
      return;
    }
    if (!confirm('‚ö†Ô∏è FINAL WARNING: This will permanently delete ALL your data including progress, scores, and settings. This cannot be undone. Are you absolutely sure?')) {
      return;
    }
    clearAllData();
    if (userNameDisplay) userNameDisplay.textContent = 'Guest';
    if (userIconDisplay) userIconDisplay.textContent = 'üë§';
    if (userNameInput) userNameInput.value = '';
    if (userIconInput) userIconInput.value = 'üë§';
    if (confirmUsernameInput) confirmUsernameInput.value = '';
    updateProgressDisplay({ progress: { level: 1, totalQuestions: 0, totalCorrect: 0, testsCompleted: 0, patientsSaved: 0, patientsLost: 0 } });
    alert('All data has been cleared. The page will reload.');
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  };
  
  if (userProfileModal) {
    userProfileModal.addEventListener('click', (e) => {
      if (e.target === userProfileModal) {
        closeUserProfile();
      }
    });
  }
  
  loadUserData();

  function getRandomTip(category = 'phlebotomy') {
    const tipsArray = category.toLowerCase().includes('phlebotomy') ? phlebotomyTips : generalNursingTips;
    return tipsArray[Math.floor(Math.random() * tipsArray.length)];
  }

  function showLoadingScreen(questionNum, totalQuestions) {
    const tip = getRandomTip(deckTitle);
    loadingTip.textContent = tip;
    loadingProgress.textContent = `Question ${questionNum + 1} of ${totalQuestions}`;
    loadingOverlay.classList.add('active');
    
    // Auto-advance after 2.5 seconds
    setTimeout(() => {
      if (loadingOverlay.classList.contains('active')) {
        hideLoadingScreen();
      }
    }, 2500);
  }

  function hideLoadingScreen() {
    loadingOverlay.classList.remove('active');
    renderQuestion();
  }

  function showAutoTip(card) {
    if (!card.tips || card.tips.length === 0) return;
    
    // Get tip from card's tips array (indices or direct strings)
    let tip = '';
    if (typeof card.tips[0] === 'number') {
      // It's an index into phlebotomyTips
      tip = phlebotomyTips[card.tips[0]] || generalNursingTips[card.tips[0]] || '';
    } else {
      // It's a direct tip string
      tip = card.tips[0];
    }
    
    if (tip) {
      tipText.textContent = tip;
      tipBanner.style.display = 'flex';
      
      // Auto-hide after 8 seconds
      setTimeout(() => {
        closeTipBanner();
      }, 8000);
    }
  }

  function closeTipBanner() {
    tipBanner.style.display = 'none';
  }

  function showHint() {
    if (deck.length === 0 || index >= deck.length) {
      alert('No question available!');
      return;
    }
    
    if (hintsUsed >= maxHintsPerQuestion) {
      alert('Maximum hints reached for this question!');
      return;
    }
    
    const currentCard = deck[index];
    let tip = '';
    
    // Check if card has specific tips
    if (currentCard.tips && currentCard.tips.length > 0) {
      const tipIndex = hintsUsed < currentCard.tips.length ? hintsUsed : Math.floor(Math.random() * currentCard.tips.length);
      if (typeof currentCard.tips[tipIndex] === 'number') {
        tip = phlebotomyTips[currentCard.tips[tipIndex]] || generalNursingTips[currentCard.tips[tipIndex]] || '';
      } else {
        tip = currentCard.tips[tipIndex];
      }
    }
    
    // Fallback to random tip from category
    if (!tip) {
      tip = getRandomTip(deckTitle);
    }
    
    // Ensure tip banner elements exist
    if (!tipText || !tipBanner) {
      console.error('Tip banner elements not found!');
      return;
    }
    
    tipText.textContent = tip;
    tipBanner.style.display = 'flex';
    tipBanner.style.opacity = '1';
    hintsUsed++;
    
    // Update hint button if max reached
    if (hintsUsed >= maxHintsPerQuestion) {
      if (hintButton) {
        hintButton.disabled = true;
        hintButton.textContent = 'üí° Max Hints';
      }
    }
    
    // Clear any existing timeout
    if (window.hintTimeout) {
      clearTimeout(window.hintTimeout);
    }
    
    // Auto-hide after 10 seconds with fade
    window.hintTimeout = setTimeout(() => {
      if (tipBanner) {
        tipBanner.style.opacity = '0';
        setTimeout(() => {
          tipBanner.style.display = 'none';
        }, 500);
      }
    }, 10000);
  }
  
  // Expose showHint globally
  window.showHint = showHint;
  
  // Expose showHint globally
  window.showHint = showHint;

  // Play success sound using Tone.js
  function playSuccessSound() {
    try {
      const synth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 0.8 }
      }).toDestination();
      
      const now = Tone.now();
      synth.triggerAttackRelease("C5", "8n", now);
      synth.triggerAttackRelease("E5", "8n", now + 0.1);
      synth.triggerAttackRelease("G5", "8n", now + 0.2);
    } catch (e) {
      console.log('Sound playback failed:', e);
    }
  }

  // Play failure sound - "woa woa woaaaa"
  function playFailureSound() {
    try {
      const synth = new Tone.Synth({
        oscillator: { type: "sawtooth" },
        envelope: { attack: 0.05, decay: 0.3, sustain: 0.2, release: 0.5 }
      }).toDestination();
      
      const now = Tone.now();
      // "woa woa woaaaa" pattern
      synth.triggerAttackRelease("C3", "4n", now);
      synth.triggerAttackRelease("C3", "4n", now + 0.3);
      synth.triggerAttackRelease("C2", "8n", now + 0.6);
      synth.triggerAttackRelease("C2", "8n", now + 0.75);
      synth.triggerAttackRelease("C2", "8n", now + 0.9);
      synth.triggerAttackRelease("C2", "8n", now + 1.05);
    } catch (e) {
      console.log('Failure sound failed:', e);
    }
  }

  // Play alert sound for failed test
  function playAlertSound() {
    try {
      const synth = new Tone.Synth({
        oscillator: { type: "square" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.2 }
      }).toDestination();
      
      const now = Tone.now();
      // Alert pattern
      for (let i = 0; i < 4; i++) {
        synth.triggerAttackRelease("A4", "16n", now + i * 0.2);
      }
    } catch (e) {
      console.log('Alert sound failed:', e);
    }
  }

  // Play victory sound for passed test
  function playVictorySound() {
    try {
      const synth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 0.8 }
      }).toDestination();
      
      const now = Tone.now();
      // Victory fanfare
      synth.triggerAttackRelease("C5", "8n", now);
      synth.triggerAttackRelease("E5", "8n", now + 0.15);
      synth.triggerAttackRelease("G5", "8n", now + 0.3);
      synth.triggerAttackRelease("C6", "4n", now + 0.45);
    } catch (e) {
      console.log('Victory sound failed:', e);
    }
  }

  // Text-to-speech function
  // Remove emojis from text for speech synthesis
  function removeEmojis(text) {
    if (!text) return '';
    // Remove emoji characters (Unicode ranges for emojis)
    return text.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{1F900}-\u{1F9FF}]|[\u{1FA00}-\u{1FA6F}]|[\u{1FA70}-\u{1FAFF}]/gu, '').trim();
  }

  function speakText(text, voice = null) {
    if ('speechSynthesis' in window) {
      // Remove emojis before speaking
      const cleanText = removeEmojis(text);
      if (!cleanText) return; // Don't speak if no text after emoji removal
      
      const utterance = new SpeechSynthesisUtterance(cleanText);
      if (voice) {
        const voices = speechSynthesis.getVoices();
        const selectedVoice = voices.find(v => v.name.includes(voice));
        if (selectedVoice) utterance.voice = selectedVoice;
      }
      utterance.rate = 0.9;
      utterance.pitch = 1;
      utterance.volume = 0.8;
      speechSynthesis.speak(utterance);
    }
  }

  // Show success modal
  function showSuccessModal(message) {
    const msg = message || "Patient's condition is improving! Vital signs stabilizing.";
    modalMessage.textContent = msg;
    successModal.classList.add('show');
    speakText("Excellent work! " + msg);
  }

  // Show dramatic failure screen (COD-style)
  function showFailureScreen() {
    if (!failureScreen || !failureQuote) return;
    
    // Get random quote
    const randomQuote = failureQuotes[Math.floor(Math.random() * failureQuotes.length)];
    failureQuote.textContent = `"${randomQuote}"`;
    
    // Show the failure screen
    failureScreen.style.display = 'flex';
    failureScreen.classList.add('show');
    
    // Hide after 4 seconds and proceed
    setTimeout(() => {
      hideFailureScreen();
    }, 4000);
  }

  function hideFailureScreen() {
    if (!failureScreen) return;
    failureScreen.classList.remove('show');
    setTimeout(() => {
      failureScreen.style.display = 'none';
    }, 500);
  }

  // Show failure modal
  function showFailureModal(message) {
    const msg = message || "Patient's condition deteriorated!";
    failureModalMessage.textContent = msg;
    failureModal.classList.add('show');
    speakText("Critical error. " + msg);
  }

  // Close success modal (global function for button)
  window.closeSuccessModal = function() {
    successModal.classList.remove('show');
    speechSynthesis.cancel();
  }

  // Close failure modal (global function for button)
  window.closeFailureModal = function() {
    failureModal.classList.remove('show');
    speechSynthesis.cancel();
  }

  // Close tip banner (global function for button)
  window.closeTipBanner = function() {
    if (tipBanner) tipBanner.style.display = 'none';
  }

  // showHint is already exposed above

  // Hide loading screen (global function for button)
  window.hideLoadingScreen = function() {
    hideLoadingScreen();
  }

  // Close modals when clicking outside
  successModal.addEventListener('click', (e) => {
    if (e.target === successModal) {
      closeSuccessModal();
    }
  });

  failureModal.addEventListener('click', (e) => {
    if (e.target === failureModal) {
      closeFailureModal();
    }
  });

  // Initialize Tone.js context (required for audio)
  Tone.start().then(() => {
    console.log('Audio context started');
  }).catch(e => {
    console.log('Audio context failed:', e);
  });

  // Clear timer
  function clearTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    timerContainer.innerHTML = '';
    timerContainer.style.display = 'none';
  }

  // Start timer
  function startTimer(seconds, onTimeout) {
    clearTimer();
    timeRemaining = seconds;
    timedOut = false;
    
    if (seconds <= 0) {
      timerContainer.style.display = 'none';
      return;
    }
    
    timerContainer.style.display = 'block';
    timerContainer.innerHTML = `<div class="timer" id="timerDisplay">${timeRemaining}</div>`;
    const timerDisplay = document.getElementById('timerDisplay');
    
    timerInterval = setInterval(() => {
      timeRemaining--;
      timerDisplay.textContent = timeRemaining;
      
      if (timeRemaining <= 5) {
        timerDisplay.classList.add('warning');
      }
      
      if (timeRemaining <= 0) {
        clearTimer();
        timedOut = true;
        onTimeout();
      }
    }, 1000);
  }

  function renderQuestion() {
    if (deck.length === 0) {
      showError('No scenarios loaded. Select a category or drop a JSON file to load custom scenarios.');
      return;
    }

    // Ensure elements exist
    if (!qText || !aText) {
      console.error('qText or aText elements not found!');
      return;
    }

    clearTimer();
    selected = null;
    timedOut = false;
    
    const d = deck[index];
    if (!d || !d.q) {
      console.error('Invalid card data at index:', index);
      return;
    }
    
    qText.textContent = d.q || '';
    
    // Show scenario if available
    if (d.scenario) {
      scenarioContainer.style.display = 'block';
      scenarioContainer.innerHTML = `<div class="scenario"><div class="scenario-text">üö® SCENARIO</div><div>${d.scenario}</div></div>`;
    } else {
      scenarioContainer.style.display = 'none';
      scenarioContainer.innerHTML = '';
    }
    
    // Build answer text (will show failure message if wrong)
    let answerText = d.a;
    if (d.failureMessage) {
      answerText = d.a + (selected !== null && selected !== d.correct ? `<div class="failure-message">${d.failureMessage}</div>` : '');
    }
    aText.innerHTML = answerText;
    
    // Build question number display with ID, category, and test
    const questionId = d.id || `q${index + 1}`;
    const category = d.category || '';
    const test = d.test !== undefined ? `Test ${d.test}` : '';
    const parts = [questionId];
    if (category) parts.push(category);
    if (test) parts.push(test);
    parts.push(`${index + 1}/${deck.length}`);
    qNum.textContent = parts.join(' ‚Ä¢ ');
    
    prevBtn.style.display = index > 0 ? 'block' : 'none';
    
    // Start timer if available
    if (d.timer && d.timer > 0) {
      startTimer(d.timer, () => {
        // Timeout callback
        if (selected === null) {
          const timeoutMessage = d.timeoutMessage || '‚è±Ô∏è TIME OUT - Patient condition deteriorated due to delayed response!';
          aText.innerHTML = d.a + `<div class="failure-message">${timeoutMessage}</div>`;
          showingAnswer = true;
          card.classList.add('is-flipped');
        }
      });
    }

    // Clear and render question image - always show question even if image fails
    qImageContainer.innerHTML = '';
    if (d.image) {
      const img = document.createElement('img');
      img.src = d.image;
      img.className = 'card-image';
      img.alt = 'Question image';
      img.onerror = () => { 
        // Image failed, but question still displays
        qImageContainer.innerHTML = '';
        console.log('Question image failed to load:', d.image);
      };
      img.onload = () => {
        // Image loaded successfully
      };
      qImageContainer.appendChild(img);
    }

    // Clear and render answer image - always show answer even if image fails
    aImageContainer.innerHTML = '';
    if (d.answerImage) {
      const img = document.createElement('img');
      img.src = d.answerImage;
      img.className = 'card-image';
      img.alt = 'Answer image';
      img.onerror = () => { 
        // Image failed, but answer still displays
        aImageContainer.innerHTML = '';
        console.log('Answer image failed to load:', d.answerImage);
      };
      img.onload = () => {
        // Image loaded successfully
      };
      aImageContainer.appendChild(img);
    }

    choicesEl.innerHTML = '';
    selected = null;
    hintsUsed = 0; // Reset hints for new question
    closeTipBanner(); // Close any open tips
    
    // Show hint button
    if (hintButton) {
      hintButton.style.display = 'flex';
      hintButton.disabled = false;
      hintButton.textContent = 'üí° Hint';
    }
    
    // Show auto tip if available
    showAutoTip(d);

    if (d.choices && d.choices.length > 0) {
      d.choices.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = 'choice';
        div.textContent = String.fromCharCode(65 + i) + '. ' + c;
        div.onclick = e => {
          e.stopPropagation();
          if (selected !== null || completed || timedOut) return;
          
          clearTimer(); // Stop timer when answer is selected
          selected = i;
          document.querySelectorAll('.choice').forEach(el => el.classList.remove('selected', 'correct', 'wrong'));
          div.classList.add('selected');
          
          if (i === d.correct) {
            div.classList.add('correct');
            score++;
            
            // Track patient saved
            const userData = getUserData() || {};
            userData.progress = userData.progress || { level: 1, totalQuestions: 0, totalCorrect: 0, testsCompleted: 0, patientsSaved: 0, patientsLost: 0 };
            userData.progress.patientsSaved = (userData.progress.patientsSaved || 0) + 1;
            userData.progress.totalCorrect = (userData.progress.totalCorrect || 0) + 1;
            userData.progress.totalQuestions = (userData.progress.totalQuestions || 0) + 1;
            
            // Calculate level based on total questions answered
            const newLevel = Math.floor(userData.progress.totalQuestions / 10) + 1;
            userData.progress.level = newLevel;
            
            saveUserData(userData);
            updateProgressDisplay(userData);
            
            // Play success sound
            playSuccessSound();
            
            // Show success message in answer
            const successMsg = d.successMessage || '‚úÖ Patient\'s condition is improving! Vital signs stabilizing.';
            aText.innerHTML = d.a + `<div class="success-message">${successMsg}</div>`;
            
            // Auto-flip to answer after short delay
            setTimeout(() => {
              showingAnswer = true;
              card.classList.add('is-flipped');
              
              // Show congratulations modal
              setTimeout(() => {
                showSuccessModal(successMsg);
              }, 500);
            }, 800);
          } else {
            div.classList.add('wrong');
            if (d.correct !== undefined) {
              const correctEl = choicesEl.children[d.correct];
              if (correctEl) correctEl.classList.add('correct');
            }
            
            // Track patient lost
            const userData = getUserData() || {};
            userData.progress = userData.progress || { level: 1, totalQuestions: 0, totalCorrect: 0, testsCompleted: 0, patientsSaved: 0, patientsLost: 0 };
            userData.progress.patientsLost = (userData.progress.patientsLost || 0) + 1;
            userData.progress.totalQuestions = (userData.progress.totalQuestions || 0) + 1;
            
            // Calculate level based on total questions answered
            const newLevel = Math.floor(userData.progress.totalQuestions / 10) + 1;
            userData.progress.level = newLevel;
            
            saveUserData(userData);
            updateProgressDisplay(userData);
            
            // Play failure sound
            playFailureSound();
            
            // Show dramatic failure screen first (COD-style)
            showFailureScreen();
            
            // Create death certificate with system time
            const now = new Date();
            const deathTime = now.toLocaleTimeString();
            const deathDate = now.toLocaleDateString();
            const causeOfDeath = d.causeOfDeath || 'Incorrect medical intervention';
            
            const deathCertificate = `
              <div class="death-certificate">
                <div class="death-header">üíÄ DEATH CERTIFICATE</div>
                <div class="death-info">
                  <div><strong>Time of Death:</strong> ${deathTime}</div>
                  <div><strong>Date:</strong> ${deathDate}</div>
                  <div><strong>Cause of Death:</strong> ${causeOfDeath}</div>
                  <div><strong>Patient Status:</strong> DECEASED</div>
                </div>
              </div>
            `;
            
            // Show failure message with death certificate
            const failureMsg = d.failureMessage || 'üíÄ CRITICAL ERROR: Patient\'s condition deteriorated due to incorrect assessment.';
            aText.innerHTML = d.a + `<div class="failure-message">${failureMsg}</div>` + deathCertificate;
            
            // Auto-flip to answer after failure screen fades (after 4.5 seconds total)
            setTimeout(() => {
              showingAnswer = true;
              card.classList.add('is-flipped');
              
              // Show failure modal with text-to-speech
              setTimeout(() => {
                showFailureModal(failureMsg);
              }, 500);
            }, 4500);
          }
        };
        choicesEl.appendChild(div);
      });
    }
  }

  function showCompletion() {
    completed = true;
    clearTimer();
    closeSuccessModal();
    closeFailureModal();
    
    // Track test completion
    const userData = getUserData() || {};
    userData.progress = userData.progress || { level: 1, totalQuestions: 0, totalCorrect: 0, testsCompleted: 0, patientsSaved: 0, patientsLost: 0 };
    userData.progress.testsCompleted = (userData.progress.testsCompleted || 0) + 1;
    saveUserData(userData);
    updateProgressDisplay(userData);
    
    const percentage = Math.round((score / deck.length) * 100);
    const passed = percentage >= 70;
    
    if (passed) {
      playVictorySound();
      qText.textContent = `Test Passed! üéâ`;
      choicesEl.innerHTML = `
        <p style="text-align: center; font-size: 1.2rem; color: var(--good);">
          Your score: ${score} / ${deck.length} (${percentage}%)<br/>
          <strong>Congratulations! You passed!</strong><br/>
          <small style="opacity: 0.8;">Tap to restart</small>
        </p>
      `;
      speakText(`Congratulations! You passed the test with a score of ${percentage} percent!`);
    } else {
      playAlertSound();
      qText.textContent = `Test Failed ‚ö†Ô∏è`;
      choicesEl.innerHTML = `
        <p style="text-align: center; font-size: 1.2rem; color: var(--bad);">
          Your score: ${score} / ${deck.length} (${percentage}%)<br/>
          <strong>You need 70% to pass. Study more and try again!</strong><br/>
          <small style="opacity: 0.8;">Tap to restart</small>
        </p>
      `;
      speakText(`Test failed. You scored ${percentage} percent. You need 70 percent to pass. Study more and try again.`);
    }
    
    aText.textContent = '';
    qImageContainer.innerHTML = '';
    aImageContainer.innerHTML = '';
  }

  function advance(e) {
    // Prevent event bubbling if called from child elements
    if (e) {
      e.stopPropagation();
      // Don't flip if clicking on interactive elements
      if (e.target.closest('.choice') || e.target.closest('.hint-button') || e.target.closest('.back-btn') || e.target.closest('button')) {
        return;
      }
    }

    if (completed) {
      completed = false;
      index = 0;
      score = 0;
      clearTimer();
      closeSuccessModal();
      card.classList.remove('is-flipped');
      showingAnswer = false;
      renderQuestion();
      return;
    }

    if (!showingAnswer) {
      // Always allow tap to reveal answer
      showingAnswer = true;
      card.classList.add('is-flipped');
    } else {
      showingAnswer = false;
      card.classList.remove('is-flipped');
      clearTimer();
      closeSuccessModal();
      closeFailureModal();
      speechSynthesis.cancel();
      index++;
      if (index >= deck.length) {
        showCompletion();
      } else {
        // Show loading screen before next question
        showLoadingScreen(index, deck.length);
      }
    }
  }

  prevBtn.onclick = e => {
    e.stopPropagation();
    if (index > 0 && !completed) {
      index--;
      showingAnswer = false;
      card.classList.remove('is-flipped');
      renderQuestion();
    }
  };

  // Add both click and touch event handlers for full compatibility
  card.onclick = advance;
  card.addEventListener('touchstart', function(e) {
    e.preventDefault();
    advance(e);
  }, { passive: false });

  // Category selection

  // Drag and drop
  scene.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('active');
  });

  scene.addEventListener('dragleave', (e) => {
    if (e.target === dropZone || !dropZone.contains(e.relatedTarget)) {
      dropZone.classList.remove('active');
    }
  });

  scene.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('active');
    
    const files = Array.from(e.dataTransfer.files);
    const jsonFile = files.find(f => f.name.endsWith('.json'));
    
    if (jsonFile) {
      const reader = new FileReader();
      reader.onload = (event) => {
        loadDeckFromFile(event.target.result, jsonFile.name);
      };
      reader.onerror = () => {
        showError('Failed to read file. Please try again.');
      };
      reader.readAsText(jsonFile);
    } else {
      showError('Please drop a JSON file');
    }
  });

  // Auto-load phlebotomy category
  loadDeck('phlebotomy');
});
</script>

</body>
</html>
